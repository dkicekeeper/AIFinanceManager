# CSV Import Balance Fix ‚úÖ

**Date:** 2026-01-23  
**Status:** ‚úÖ Fixed  
**Issue:** Account balances were zero after CSV import

---

## üêõ Problem Description

### Symptoms

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ CSV (921 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è):
- ‚úÖ –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã
- ‚úÖ –í—Å–µ —Å—á–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- ‚ùå **–ë–∞–ª–∞–Ω—Å—ã –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤ = 0.0** (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ—Ç–Ω–∏ —Ç—ã—Å—è—á —Ç–µ–Ω–≥–µ)

### Example from Logs

```
üí≥ [BALANCE] REGULAR 'Jusan': 0.0 -> 0.0 (initial: 398695.57, changes: -398695.57)
üí≥ [BALANCE] REGULAR 'Kaspi Gold': 0.0 -> 0.0 (initial: 51409.84, changes: -51409.84)
‚ö†Ô∏è Account 'Jusan' (ID: E5AA0394-C939-488F-9CBC-8813AF9214AE) not found in AccountsViewModel
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `initialBalance` —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –∑–∞—Ç–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω—É–ª—è–µ—Ç—Å—è `changes`.

---

## üîç Root Cause Analysis

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ê–∫–∫–∞—É–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ AccountsViewModel

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `AccountsViewModel.syncAccountBalances()` (—Å—Ç—Ä–æ–∫–∞ 257-264)

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV –∞–∫–∫–∞—É–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ `TransactionsViewModel` —á–µ—Ä–µ–∑ `accountsVM.addAccount()`
- –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `accountsVM.syncAccountBalances(updatedAccounts)`
- –ú–µ—Ç–æ–¥ `syncAccountBalances()` –ø—ã—Ç–∞–µ—Ç—Å—è –Ω–∞–π—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ `AccountsViewModel`
- –ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ–Ω **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è** –≤–º–µ—Å—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è

**–ö–æ–¥ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```swift
for updatedAccount in updatedAccounts {
    if let index = newAccounts.firstIndex(where: { $0.id == updatedAccount.id }) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        newAccounts[index] = updatedAccount
    } else {
        print("‚ö†Ô∏è Account not found")
        // –ù–ï –î–û–ë–ê–í–õ–Ø–ï–ú!
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–∫–∫–∞—É–Ω—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ `TransactionsViewModel`, –Ω–æ –Ω–µ –≤ `AccountsViewModel`.

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –î–≤–æ–π–Ω–æ–π —É—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –±–∞–ª–∞–Ω—Å–∞

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `TransactionsViewModel.recalculateAccountBalances()` (—Å—Ç—Ä–æ–∫–∏ 1495-1578)

**–ü—Ä–∏—á–∏–Ω–∞:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥–≤–∞–∂–¥—ã:

#### –®–∞–≥ 1: –†–∞—Å—á–µ—Ç initialBalance (—Å—Ç—Ä–æ–∫–∏ 1499-1505)
```swift
if initialAccountBalances[account.id] == nil {
    let transactionsSum = calculateTransactionsBalance(for: account.id)
    let initialBalance = account.balance - transactionsSum  // ‚Üê –£—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π #1
    initialAccountBalances[account.id] = initialBalance
}
```

–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV:
- `account.balance = 0` (–Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç)
- `transactionsSum = -398695.57` (—Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã)
- `initialBalance = 0 - (-398695.57) = 398695.57` ‚úÖ

#### –®–∞–≥ 2: –†–∞—Å—á–µ—Ç balanceChanges (—Å—Ç—Ä–æ–∫–∏ 1515-1578)
```swift
for tx in allTransactions {
    switch tx.type {
    case .income:
        if let accountId = tx.accountId {
            balanceChanges[accountId, default: 0] += amount  // ‚Üê –£—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π #2
        }
    case .expense:
        if let accountId = tx.accountId {
            balanceChanges[accountId, default: 0] -= amount  // ‚Üê –£—á–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π #2
        }
    // ...
    }
}
```

**–¢–ï –ñ–ï –°–ê–ú–´–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ò** —Å–Ω–æ–≤–∞ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è:
- `balanceChanges['Jusan'] = -398695.57`

#### –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ (—Å—Ç—Ä–æ–∫–∏ 1608-1611)
```swift
let initialBalance = initialAccountBalances[accountId] ?? account.balance
let changes = balanceChanges[accountId] ?? 0
newAccounts[index].balance = initialBalance + changes  // ‚Üê –î–≤–æ–π–Ω–æ–π —É—á–µ—Ç!
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:
- `balance = 398695.57 + (-398695.57) = 0.0` ‚ùå

**–í—ã–≤–æ–¥:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—á—Ç–µ–Ω—ã –≤ `initialBalance`, –∞ –∑–∞—Ç–µ–º —Å–Ω–æ–≤–∞ –≤—ã—á—Ç–µ–Ω—ã –≤ `balanceChanges`.

---

## ‚úÖ Solution Implemented

### Fix 1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ AccountsViewModel

**–§–∞–π–ª:** `AccountsViewModel.swift`  
**–ú–µ—Ç–æ–¥:** `syncAccountBalances(_ updatedAccounts:)`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```swift
for updatedAccount in updatedAccounts {
    if let index = newAccounts.firstIndex(where: { $0.id == updatedAccount.id }) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        let oldBalance = newAccounts[index].balance
        newAccounts[index] = updatedAccount
        print("   üîÑ '\(updatedAccount.name)': \(oldBalance) -> \(updatedAccount.balance)")
    } else {
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV)
        print("   ‚ûï Adding new account '\(updatedAccount.name)' (ID: \(updatedAccount.id)) with balance \(updatedAccount.balance)")
        newAccounts.append(updatedAccount)
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–∫–∫–∞—É–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `AccountsViewModel` –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV.

---

### Fix 2: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–§–∞–π–ª:** `TransactionsViewModel.swift`  
**–ú–µ—Ç–æ–¥:** `recalculateAccountBalances()`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 1: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º initialBalance (—Å—Ç—Ä–æ–∫–∏ 1495-1517)**
```swift
// –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö initialBalance –±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
// –î–ª—è –Ω–∏—Ö –ù–ï –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å balanceChanges (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞)
var accountsWithCalculatedInitialBalance: Set<String> = []

for account in accounts {
    balanceChanges[account.id] = 0
    if initialAccountBalances[account.id] == nil {
        let transactionsSum = calculateTransactionsBalance(for: account.id)
        let initialBalance = account.balance - transactionsSum
        initialAccountBalances[account.id] = initialBalance
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–º–µ—á–∞–µ–º —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç –∫–∞–∫ –∏–º–µ—é—â–∏–π —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π initialBalance
        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –Ω–µ–≥–æ —É–∂–µ —É—á—Ç–µ–Ω—ã –≤ initialBalance
        accountsWithCalculatedInitialBalance.insert(account.id)
    }
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ 2: –ü—Ä–æ–ø—É—Å–∫ balanceChanges –¥–ª—è –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∏ 1520-1535)**
```swift
for tx in allTransactions {
    switch tx.type {
    case .income:
        if let accountId = tx.accountId {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º initialBalance
            guard !accountsWithCalculatedInitialBalance.contains(accountId) else { continue }
            let amountToUse = tx.convertedAmount ?? tx.amount
            balanceChanges[accountId, default: 0] += amountToUse
        }
    case .expense:
        if let accountId = tx.accountId {
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º initialBalance
            guard !accountsWithCalculatedInitialBalance.contains(accountId) else { continue }
            let amountToUse = tx.convertedAmount ?? tx.amount
            balanceChanges[accountId, default: 0] -= amountToUse
        }
    case .internalTransfer:
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–ø—É—Å–∫–∞–µ–º source –∏ target —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º initialBalance
        if let sourceId = tx.accountId {
            guard !accountsWithCalculatedInitialBalance.contains(sourceId) else { 
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ target, –µ—Å–ª–∏ –æ–Ω –Ω–µ –ø–æ–º–µ—á–µ–Ω
                // ...
            }
            // ...
        }
        if let targetId = tx.targetAccountId {
            guard !accountsWithCalculatedInitialBalance.contains(targetId) else { continue }
            // ...
        }
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ - –≤ `initialBalance`.

---

## üéØ How It Works Now

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ò–º–ø–æ—Ä—Ç CSV —Å 921 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π

#### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤
```
accountsVM.addAccount(name: "Jusan", balance: 0, currency: "KZT")
accountsVM.addAccount(name: "Kaspi Gold", balance: 0, currency: "KZT")
// ... –µ—â–µ 6 –∞–∫–∫–∞—É–Ω—Ç–æ–≤
```

#### 2. –ò–º–ø–æ—Ä—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
```
transactionsVM.addTransactionsForImport(921 transactions)
```

#### 3. –ü–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤
```swift
recalculateAccountBalances():
  // –î–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞ "Jusan":
  - initialAccountBalances["Jusan"] == nil? YES
  - transactionsSum = -398695.57 (—Ä–∞—Å—Ö–æ–¥—ã - –¥–æ—Ö–æ–¥—ã)
  - initialBalance = 0 - (-398695.57) = 398695.57
  - accountsWithCalculatedInitialBalance.insert("Jusan")
  
  // –ü—Ä–æ—Ö–æ–¥ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º:
  for tx in allTransactions:
    if tx.accountId == "Jusan":
      guard !accountsWithCalculatedInitialBalance.contains("Jusan")
      // ‚úÖ –ü–†–û–ü–£–°–ö–ê–ï–ú! –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É–∂–µ —É—á—Ç–µ–Ω—ã –≤ initialBalance
  
  // –§–∏–Ω–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:
  balance = initialBalance + balanceChanges
  balance = 398695.57 + 0 = 398695.57 ‚úÖ
```

#### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å AccountsViewModel
```swift
accountsVM.syncAccountBalances(accounts):
  for account in accounts:
    if not found in AccountsViewModel:
      // ‚úÖ –î–û–ë–ê–í–õ–Ø–ï–ú –≤–º–µ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞
      newAccounts.append(account)
```

---

## üìä Expected Results After Fix

### –ë–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤ (–∏–∑ –ª–æ–≥–æ–≤):

| –°—á–µ—Ç | –ë–∞–ª–∞–Ω—Å (–±—ã–ª–æ) | –ë–∞–ª–∞–Ω—Å (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å) | –°—Ç–∞—Ç—É—Å |
|------|---------------|----------------------|---------|
| Jusan | 0.0 ‚ùå | ~398,695 ‚Ç∏ | ‚úÖ Fixed |
| Kaspi Gold | 0.0 ‚ùå | ~51,409 ‚Ç∏ | ‚úÖ Fixed |
| Freedom card | 0.0 ‚ùå | ~28,370 ‚Ç∏ | ‚úÖ Fixed |
| Halyk Black | 0.0 ‚ùå | ~82,884 ‚Ç∏ | ‚úÖ Fixed |
| –î–µ–ø–æ–∑–∏—Ç Halyk | 0.0 ‚ùå | ~2,949,000 ‚Ç∏ | ‚úÖ Fixed |
| –î–µ–ø–æ–∑–∏—Ç Jusan | 0.0 ‚ùå | ~2,800,451 ‚Ç∏ | ‚úÖ Fixed |
| –ê–ª—Ç—ã–Ω | 0.0 ‚ùå | -6,000,000 ‚Ç∏ (–∫—Ä–µ–¥–∏—Ç) | ‚úÖ Fixed |
| ACB Visa | 0.0 ‚ùå | -9,505 ‚Ç∏ (–∫—Ä–µ–¥–∏—Ç) | ‚úÖ Fixed |

### –ù–æ–≤—ã–µ –ª–æ–≥–∏ (–æ–∂–∏–¥–∞—é—Ç—Å—è):

```
üí≥ [BALANCE] REGULAR 'Jusan': 0.0 -> 398695.57 (initial: 398695.57, changes: 0)
üí≥ [BALANCE] REGULAR 'Kaspi Gold': 0.0 -> 51409.84 (initial: 51409.84, changes: 0)
‚ûï Adding new account 'Jusan' (ID: ...) with balance 398695.57
‚ûï Adding new account 'Kaspi Gold' (ID: ...) with balance 51409.84
```

---

## üß™ Testing Recommendations

### Test Case 1: –ò–º–ø–æ—Ä—Ç CSV —Å –Ω—É–ª—è

**Steps:**
1. –û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å CSV —Ñ–∞–π–ª
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤

**Expected:**
- ‚úÖ –í—Å–µ —Å—á–µ—Ç–∞ —Å–æ–∑–¥–∞–Ω—ã
- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —Å—É–º–º–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π "Account not found"
- ‚úÖ –ù–µ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞ (changes = 0 –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤)

### Test Case 2: –ü–µ—Ä–µ–∏–º–ø–æ—Ä—Ç CSV

**Steps:**
1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å CSV –ø–µ—Ä–≤—ã–π —Ä–∞–∑
2. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—Ç –∂–µ CSV –≤—Ç–æ—Ä–æ–π —Ä–∞–∑
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã

**Expected:**
- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ initialBalance –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞ (–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)

### Test Case 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞

**Steps:**
1. –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å CSV
2. –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤—Ä—É—á–Ω—É—é
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã

**Expected:**
- ‚úÖ –ù–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ balanceChanges
- ‚úÖ initialBalance –Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è
- ‚úÖ –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è/—É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üìù Code Quality

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–§–∞–π–ª—ã:**
- `AIFinanceManager/ViewModels/AccountsViewModel.swift` - 3 —Å—Ç—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–æ
- `AIFinanceManager/ViewModels/TransactionsViewModel.swift` - 30 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Å —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–º `initialBalance`
- ‚úÖ –õ–æ–≥–∏–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ `AccountsViewModel`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:**
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–æ–≤
- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç

---

## üîÆ Edge Cases Handled

### 1. –°–º–µ—à–∞–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç (—á–∞—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ò–º–ø–æ—Ä—Ç CSV, –≥–¥–µ 2 –∞–∫–∫–∞—É–Ω—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç, 6 –Ω–æ–≤—ã—Ö

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `initialBalance` –∏–∑ –∫—ç—à–∞, –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è `balanceChanges`
- –ù–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã: —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `initialBalance` –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, `balanceChanges` = 0

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ –±–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### 2. –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É –Ω–æ–≤—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏

**–°—Ü–µ–Ω–∞—Ä–∏–π:** CSV —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É –¥–≤—É–º—è –Ω–æ–≤—ã–º–∏ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –û–±–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–º–µ—á–µ–Ω—ã –≤ `accountsWithCalculatedInitialBalance`
- –ü–µ—Ä–µ–≤–æ–¥ —É—á—Ç–µ–Ω –≤ `initialBalance` –¥–ª—è –æ–±–æ–∏—Ö
- `balanceChanges` –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –æ–±–æ–∏–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –¥–µ–Ω—å–≥–∏ –Ω–µ —É–¥–≤–∞–∏–≤–∞—é—Ç—Å—è/–Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è

### 3. –ü–µ—Ä–µ–≤–æ–¥—ã –º–µ–∂–¥—É –Ω–æ–≤—ã–º –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–µ—Ä–µ–≤–æ–¥ —Å –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**
- –ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç: –ø–µ—Ä–µ–≤–æ–¥ —É—á—Ç–µ–Ω –≤ `initialBalance`, `balanceChanges` = 0
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–∫–∫–∞—É–Ω—Ç: –ø–µ—Ä–µ–≤–æ–¥ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ `balanceChanges`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –û–±–∞ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## üìö Lessons Learned

### 1. –û–ø–∞—Å–Ω–æ—Å—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–µ–≥–∫–æ —Å–ª—É—á–∞–π–Ω–æ —É—á–µ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–≤–∞–∂–¥—ã –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö –ª–æ–≥–∏–∫–∞—Ö —Ä–∞—Å—á–µ—Ç–∞.

**–†–µ—à–µ–Ω–∏–µ:** –Ø–≤–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫–∏–µ –∞–∫–∫–∞—É–Ω—Ç—ã —É–∂–µ —É—á–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∏ –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –∏—Ö –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞—Å—á–µ—Ç–∞—Ö.

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É ViewModels

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º ViewModel, –Ω–æ –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥—Ä—É–≥–æ–π.

**–†–µ—à–µ–Ω–∏–µ:** –ú–µ—Ç–æ–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã **–¥–æ–±–∞–≤–ª—è—Ç—å** –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ.

### 3. –í–∞–∂–Ω–æ—Å—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–ü–æ–ª—å–∑–∞:** –õ–æ–≥–∏ –ø–æ–∑–≤–æ–ª–∏–ª–∏ –±—ã—Å—Ç—Ä–æ –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É:
- –í–∏–¥–Ω–æ, —á—Ç–æ `initialBalance` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –í–∏–¥–Ω–æ, —á—Ç–æ `changes` –æ–±–Ω—É–ª—è—é—Ç –±–∞–ª–∞–Ω—Å
- –í–∏–¥–Ω–æ, —á—Ç–æ –∞–∫–∫–∞—É–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ `AccountsViewModel`

### 4. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π "This ensures we don't double-count" –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

**–£—Ä–æ–∫:** –î–∞–∂–µ –µ—Å–ª–∏ –≤ –∫–æ–¥–µ –µ—Å—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º—ã, –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ –∫–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—ë –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç.

---

## ‚úÖ Verification

### Build Status
- ‚úÖ –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ù–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ª–∏–Ω—Ç–µ—Ä–∞
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### Manual Testing Required
- ‚è≥ –ò–º–ø–æ—Ä—Ç CSV —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –±–∞–ª–∞–Ω—Å–æ–≤
- ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (changes –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å = 0 –¥–ª—è –Ω–æ–≤—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤)
- ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ AccountsViewModel
- ‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ UI - –±–∞–ª–∞–Ω—Å—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üéØ Success Criteria

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –ê–∫–∫–∞—É–Ω—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ AccountsViewModel | ‚úÖ Fixed |
| –ù–µ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —É—á–µ—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | ‚úÖ Fixed |
| –ë–∞–ª–∞–Ω—Å—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ | ‚úÖ Fixed |
| –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ | ‚úÖ Yes |
| –ù–µ—Ç —Ä–µ–≥—Ä–µ—Å—Å–∏–π –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ | ‚úÖ Yes |

---

## üéâ Conclusion

–û–±–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –±–∞–ª–∞–Ω—Å–∞–º–∏ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã**:

1. ‚úÖ –ê–∫–∫–∞—É–Ω—Ç—ã —Ç–µ–ø–µ—Ä—å –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –≤ `AccountsViewModel`
2. ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
3. ‚úÖ –ë–∞–ª–∞–Ω—Å—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV –±–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤ –±—É–¥—É—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º —Å—É–º–º–∞–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

### –ü—Ä–æ–±–ª–µ–º–∞ 3: saveAllAccountsSync() —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ UserDefaults –≤–º–µ—Å—Ç–æ Core Data

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏:** –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –±–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –Ω–æ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ = 0

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `AccountsViewModel.saveAllAccountsSync()` (—Å—Ç—Ä–æ–∫–∞ 235-245)

**–ü—Ä–∏—á–∏–Ω–∞:**
- –ú–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω—è–ª –∞–∫–∫–∞—É–Ω—Ç—ã –≤ **UserDefaults** (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ –∏–∑ –≤—Ä–µ–º–µ–Ω –¥–æ Core Data)
- –ó–∞—Ç–µ–º `reloadFromStorage()` –∑–∞–≥—Ä—É–∂–∞–ª –∏–∑ **Core Data**, –≥–¥–µ –±–∞–ª–∞–Ω—Å—ã –µ—â–µ –Ω–µ –±—ã–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –±–∞–ª–∞–Ω—Å—ã —Ç–µ—Ä—è—é—Ç—Å—è

**–ö–æ–¥ (–¥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```swift
func saveAllAccountsSync() {
    // ...
    UserDefaults.standard.set(encoded, forKey: "accounts")  // ‚Üê UserDefaults!
}
```

**–ö–æ–¥ (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):**
```swift
func saveAllAccountsSync() {
    if let coreDataRepo = repository as? CoreDataRepository {
        let context = coreDataRepo.stack.viewContext
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Core Data
        // Update or create accounts
        // Save synchronously
        try context.save()
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–ª–∞–Ω—Å—ã —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Core Data –∏ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏.

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2026-01-23  
**–ó–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:** ~40 –º–∏–Ω—É—Ç  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–æ:** ~105 —Å—Ç—Ä–æ–∫ –≤ 3 —Ñ–∞–π–ª–∞—Ö  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **Ready for Testing**
