# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: AIFinanceManager –ø—Ä–∏ 19202 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2026-01-28
**–°—Ç–∞—Ç—É—Å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
**–í–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö:** 19202 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –º–Ω–æ–∂–µ—Å—Ç–≤–æ —Å—á–µ—Ç–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–†–µ–∑—é–º–µ](#—Ä–µ–∑—é–º–µ)
2. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã](#–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–ø—Ä–æ–±–ª–µ–º—ã)
3. [–ü—Ä–æ–±–ª–µ–º—ã –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞](#–ø—Ä–æ–±–ª–µ–º—ã-–≤—ã—Å–æ–∫–æ–≥–æ-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
4. [–ü—Ä–æ–±–ª–µ–º—ã —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞](#–ø—Ä–æ–±–ª–µ–º—ã-—Å—Ä–µ–¥–Ω–µ–≥–æ-–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
5. [–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º](#–¥–µ—Ç–∞–ª—å–Ω—ã–π-–∞–Ω–∞–ª–∏–∑-–ø–æ-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º)
6. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏-–ø–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
7. [–ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è](#–ø–ª–∞–Ω-–≤–Ω–µ–¥—Ä–µ–Ω–∏—è)
8. [–û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã](#–æ–∂–∏–¥–∞–µ–º—ã–µ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)

---

## –†–µ–∑—é–º–µ

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 4/10

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å 19202 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏. –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã:

| –°–∏–º–ø—Ç–æ–º | –ü—Ä–∏—á–∏–Ω–∞ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|---------|---------|-------------|
| –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ UI –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ Core Data | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| –í—ã—Å–æ–∫–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ (~30-50 –ú–ë) | –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ø–∞–º—è—Ç—å | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| –ó–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV | –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ main thread | üî¥ –ö—Ä–∏—Ç–∏—á–Ω–∞—è |
| –ó–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ | üü† –í—ã—Å–æ–∫–∞—è |
| –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | –î–≤–æ–π–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö | üü† –í—ã—Å–æ–∫–∞—è |

### –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º: 14

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:** 3
- **–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 5
- **–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** 6

---

## –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û–¢–°–£–¢–°–¢–í–ò–ï FETCH INDEXES –í CORE DATA –ú–û–î–ï–õ–ò

**–§–∞–π–ª:** `AIFinanceManager/CoreData/AIFinanceManager.xcdatamodeld/AIFinanceManager.xcdatamodel/contents`
**–°—Ç—Ä–æ–∫–∏:** 104-122 (TransactionEntity)

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

Core Data –º–æ–¥–µ–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ `uniquenessConstraints` –¥–ª—è `id`, –Ω–æ **–Ω–µ –∏–º–µ–µ—Ç fetch indexes** –¥–ª—è –ø–æ–ª–µ–π, —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö:

```xml
<!-- –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ TransactionEntity -->
<entity name="TransactionEntity" ...>
    <attribute name="date" attributeType="Date"/>          <!-- –ù–ï–¢ –ò–ù–î–ï–ö–°–ê! -->
    <attribute name="category" attributeType="String"/>    <!-- –ù–ï–¢ –ò–ù–î–ï–ö–°–ê! -->
    <attribute name="type" attributeType="String"/>        <!-- –ù–ï–¢ –ò–ù–î–ï–ö–°–ê! -->
    <!-- ... -->
    <uniquenessConstraints>
        <uniquenessConstraint>
            <constraint value="id"/>  <!-- –¢–æ–ª—å–∫–æ uniqueness, –Ω–µ fetch index -->
        </uniquenessConstraint>
    </uniquenessConstraints>
</entity>
```

#### –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è

| –û–ø–µ—Ä–∞—Ü–∏—è | –ë–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ | –° –∏–Ω–¥–µ–∫—Å–æ–º | –†–∞–∑–Ω–∏—Ü–∞ |
|----------|-------------|------------|---------|
| Fetch –ø–æ –¥–∞—Ç–µ | O(n) = ~200–º—Å | O(log n) = ~5–º—Å | **40x –º–µ–¥–ª–µ–Ω–Ω–µ–µ** |
| –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ | O(n) = ~150–º—Å | O(log n) = ~3–º—Å | **50x –º–µ–¥–ª–µ–Ω–Ω–µ–µ** |
| –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ | O(n log n) = ~500–º—Å | O(n) —Å –∏–Ω–¥–µ–∫—Å–æ–º = ~50–º—Å | **10x –º–µ–¥–ª–µ–Ω–Ω–µ–µ** |

#### –ü—Ä–∏–º–µ—Ä –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–≥–æ –∫–æ–¥–∞

```swift
// CoreDataRepository.swift:46-50
if let dateRange = dateRange {
    request.predicate = NSPredicate(
        format: "date >= %@ AND date <= %@",  // ‚Üê –ü–û–õ–ù–û–ï –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶–´!
        dateRange.start as NSDate,
        dateRange.end as NSDate
    )
}
```

#### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–∏—Ç—å fetch indexes –≤ `.xcdatamodel`:

```xml
<entity name="TransactionEntity" ...>
    <!-- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã -->

    <!-- –î–û–ë–ê–í–ò–¢–¨: Fetch Indexes -->
    <fetchIndex name="byDateIndex">
        <fetchIndexElement property="date" type="Binary" order="descending"/>
    </fetchIndex>
    <fetchIndex name="byCategoryIndex">
        <fetchIndexElement property="category" type="Binary" order="ascending"/>
    </fetchIndex>
    <fetchIndex name="byTypeIndex">
        <fetchIndexElement property="type" type="Binary" order="ascending"/>
    </fetchIndex>
    <fetchIndex name="compoundDateCategoryIndex">
        <fetchIndexElement property="date" type="Binary" order="descending"/>
        <fetchIndexElement property="category" type="Binary" order="ascending"/>
    </fetchIndex>
</entity>
```

---

### 2. –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• 19202 –¢–†–ê–ù–ó–ê–ö–¶–ò–ô –í –ü–ê–ú–Ø–¢–¨ –°–†–ê–ó–£

**–§–∞–π–ª:** `AIFinanceManager/ViewModels/TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∏:** 14, 1352-1397

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

ViewModel —Ö—Ä–∞–Ω–∏—Ç **–í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –ø–∞–º—è—Ç–∏** –∫–∞–∫ `@Published` –º–∞—Å—Å–∏–≤:

```swift
// –°—Ç—Ä–æ–∫–∞ 14: –•—Ä–∞–Ω–∏—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
@Published var allTransactions: [Transaction] = []

// –°—Ç—Ä–æ–∫–∞ 1360: –ó–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
allTransactions = repository.loadTransactions(dateRange: nil)

// –°—Ç—Ä–æ–∫–∞ 1379: –ü–û–í–¢–û–†–ù–û –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï –≤ —Ñ–æ–Ω–µ
let allTxns = self.repository.loadTransactions(dateRange: nil)
```

#### –ê–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –†–∞–∑–º–µ—Ä | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ò—Ç–æ–≥–æ |
|-----------|--------|------------|-------|
| `Transaction` –æ–±—ä–µ–∫—Ç | ~500 –±–∞–π—Ç | 19202 | ~9.6 –ú–ë |
| `filteredTransactions` –∫–æ–ø–∏—è | ~500 –±–∞–π—Ç | 19202 | ~9.6 –ú–ë |
| –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã –≤ `.filter()` | ~500 –±–∞–π—Ç | 19202 √ó 3 | ~28.8 –ú–ë |
| **–ü–∏–∫–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ** | | | **~48 –ú–ë** |

#### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –º–µ—Ç–æ–¥—ã

–°–ª–µ–¥—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã –∏—Ç–µ—Ä–∏—Ä—É—é—Ç –ø–æ **–≤—Å–µ–º 19202** —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º:

| –ú–µ—Ç–æ–¥ | –°—Ç—Ä–æ–∫–∞ | –ß–∞—Å—Ç–æ—Ç–∞ –≤—ã–∑–æ–≤–∞ |
|-------|--------|----------------|
| `summary()` | 439 | –ü—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UI |
| `categoryExpenses()` | 493 | –ü—Ä–∏ –∫–∞–∂–¥–æ–º —Ä–µ–Ω–¥–µ—Ä–µ |
| `filteredTransactions` | 267 | –ü—Ä–∏ –∫–∞–∂–¥–æ–º access |
| `uniqueCategories` | 550 | –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ |
| `expenseCategories` | 558 | –ü—Ä–∏ –ø–æ–∫–∞–∑–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π |
| `groupAndSortTransactionsByDate()` | 370 | –ü—Ä–∏ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–µ |

#### –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **–ª–µ–Ω–∏–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É** —Å –ª–∏–º–∏—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ø–∞–º—è—Ç–∏:

```swift
// –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
class TransactionsViewModel {
    // –ú–∞–∫—Å–∏–º—É–º 5000 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –ø–∞–º—è—Ç–∏
    private let maxInMemoryTransactions = 5000

    // –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –º–µ—Å—è—Ü–µ–≤)
    @Published private(set) var loadedTransactions: [Transaction] = []

    // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–∏–∑ Core Data count)
    @Published private(set) var totalTransactionsCount: Int = 0

    // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
    func loadTransactions(offset: Int, limit: Int) async -> [Transaction] {
        return await repository.loadTransactions(
            offset: offset,
            limit: limit,
            sortBy: .dateDescending
        )
    }
}
```

---

### 3. –°–ò–ù–•–†–û–ù–ù–´–ï FETCH REQUESTS –ù–ê MAIN THREAD

**–§–∞–π–ª:** `AIFinanceManager/Services/CoreDataRepository.swift`
**–°—Ç—Ä–æ–∫–∏:** 259-315, 318-428

#### –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–ú–µ—Ç–æ–¥ `saveTransactionsSync()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç **—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ** –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ `viewContext` (main thread):

```swift
// –°—Ç—Ä–æ–∫–∞ 262
func saveTransactionsSync(_ transactions: [Transaction]) throws {
    let context = stack.viewContext  // ‚ö†Ô∏è MAIN THREAD CONTEXT!

    // –°—Ç—Ä–æ–∫–∞ 275: Fetch –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    let existingEntities = try context.fetch(fetchRequest)  // ‚ö†Ô∏è –ë–õ–û–ö–ò–†–£–ï–¢ UI!

    // –°—Ç—Ä–æ–∫–∞ 280: –°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è –∏–∑ 19202 —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    var existingEntitiesById = Dictionary(...)  // ‚ö†Ô∏è O(n) –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–∞ main thread

    // –°—Ç—Ä–æ–∫–∞ 290: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    for transaction in transactions {
        // ... batch –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ main thread
    }

    // –°—Ç—Ä–æ–∫–∞ 310: –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    try context.save()  // ‚ö†Ô∏è –ë–õ–û–ö–ò–†–£–ï–¢ UI –Ω–∞ 500-1000–º—Å!
}
```

#### –ò–∑–º–µ—Ä–µ–Ω–∏—è

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è –Ω–∞ main thread | –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è UX |
|----------|---------------------|------------------|
| Fetch 19202 entities | ~300-500–º—Å | UI freeze |
| Dictionary creation | ~100–º—Å | –ú–∏–∫—Ä–æ-–∑–∞–≤–∏—Å–∞–Ω–∏–µ |
| Batch update loop | ~200-300–º—Å | UI freeze |
| Context save | ~200-500–º—Å | UI freeze |
| **–ò–¢–û–ì–û** | **~800-1400–º—Å** | **–ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI** |

#### –ì–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

- `CSVImportService.swift` ‚Äî –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ CSV —Ñ–∞–π–ª–∞
- `TransactionsViewModel.swift` ‚Äî –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### –†–µ—à–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **background context** –¥–ª—è –≤—Å–µ—Ö —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```swift
func saveTransactionsSync(_ transactions: [Transaction]) throws {
    // –°–æ–∑–¥–∞—ë–º background context
    let backgroundContext = stack.container.newBackgroundContext()
    backgroundContext.mergePolicy = NSMergeByPropertyObjectTrumpMergePolicy

    try backgroundContext.performAndWait {
        // –í—Å–µ —Ç—è–∂–µ–ª—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ–Ω–µ
        let fetchRequest = TransactionEntity.fetchRequest()
        fetchRequest.fetchBatchSize = 500
        let existingEntities = try backgroundContext.fetch(fetchRequest)

        // ... batch –æ–ø–µ—Ä–∞—Ü–∏–∏ ...

        try backgroundContext.save()
    }

    // Merge –Ω–∞ main thread (–±—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
    stack.viewContext.perform {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π merge —á–µ—Ä–µ–∑ NSPersistentContainer
    }
}
```

---

## –ü—Ä–æ–±–ª–µ–º—ã –≤—ã—Å–æ–∫–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

### 4. –û–¢–°–£–¢–°–¢–í–ò–ï BATCH SIZE –í FETCH REQUESTS

**–§–∞–π–ª:** `CoreDataRepository.swift`
**–°—Ç—Ä–æ–∫–∏:** 41-54

```swift
// –¢–µ–∫—É—â–∏–π –∫–æ–¥
let request = TransactionEntity.fetchRequest()
request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]
// ‚ö†Ô∏è –ù–ï–¢ fetchBatchSize!

// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
request.fetchBatchSize = 100  // –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ 100 –æ–±—ä–µ–∫—Ç–æ–≤
```

**–í–ª–∏—è–Ω–∏–µ:** Core Data –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–ï 19202 –æ–±—ä–µ–∫—Ç–∞ —Å—Ä–∞–∑—É –≤–º–µ—Å—Ç–æ –±–∞—Ç—á–µ–π.

---

### 5. N+1 –ü–†–û–ë–õ–ï–ú–ê: –û–¢–°–£–¢–°–¢–í–ò–ï PREFETCHING –î–õ–Ø RELATIONSHIPS

**–§–∞–π–ª:** `CoreDataRepository.swift`
**–°—Ç—Ä–æ–∫–∏:** 41-54

```swift
// –¢–µ–∫—É—â–∏–π –∫–æ–¥ ‚Äî –Ω–µ—Ç prefetching!
let request = TransactionEntity.fetchRequest()

// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
request.relationshipKeyPathsForPrefetching = ["account", "recurringSeries"]
```

**–í–ª–∏—è–Ω–∏–µ:** –ü—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ `transaction.account` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π SQL –∑–∞–ø—Ä–æ—Å. –î–ª—è 19202 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π = –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ **19202 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤**.

---

### 6. –ú–ù–û–ñ–ï–°–¢–í–ï–ù–ù–´–ï –ü–û–í–¢–û–†–ù–´–ï FETCH REQUESTS

**–§–∞–π–ª:** `TransactionsViewModel.swift`

–û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ fetch –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ:

```swift
// –°—Ç—Ä–æ–∫–∞ 1360: –ü–µ—Ä–≤—ã–π fetch
allTransactions = repository.loadTransactions(dateRange: nil)

// –°—Ç—Ä–æ–∫–∞ 1371: –í—Ç–æ—Ä–æ–π fetch (—á–∞—Å—Ç–∏—á–Ω—ã–π)
let recentTransactions = repository.loadTransactions(dateRange: recentDateRange)

// –°—Ç—Ä–æ–∫–∞ 1379: –¢—Ä–µ—Ç–∏–π fetch –≤ —Ñ–æ–Ω–µ
let allTxns = self.repository.loadTransactions(dateRange: nil)
```

**–í–ª–∏—è–Ω–∏–µ:** 3 fetch requests –≤–º–µ—Å—Ç–æ 1, –∫–∞–∂–¥—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–æ 19202 –∑–∞–ø–∏—Å–µ–π.

---

### 7. –õ–ò–®–ù–ò–ï –ü–†–ï–û–ë–†–ê–ó–û–í–ê–ù–ò–Ø –ú–ê–°–°–ò–í–û–í

**–§–∞–π–ª:** `TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∏:** 267-294

```swift
var filteredTransactions: [Transaction] {
    var transactions = applyRules(to: allTransactions)  // –ö–æ–ø–∏—è #1

    if let selectedCategories = selectedCategories {
        transactions = filterService.filterByCategories(...)  // –ö–æ–ø–∏—è #2
    }

    return filterRecurringTransactions(transactions)  // –ö–æ–ø–∏—è #3
}
```

**–í–ª–∏—è–Ω–∏–µ:** –ö–∞–∂–¥—ã–π access —Å–æ–∑–¥–∞—ë—Ç –¥–æ 3 –∫–æ–ø–∏–π –º–∞—Å—Å–∏–≤–∞ = ~30 –ú–ë –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏.

---

### 8. CSV –ò–ú–ü–û–†–¢ –ë–ï–ó –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò

**–§–∞–π–ª:** `CSVImportService.swift`
**–°—Ç—Ä–æ–∫–∞:** 115

```swift
let batchSize = 100  // ‚ö†Ô∏è –°–õ–ò–®–ö–û–ú –ú–ê–õ–ï–ù–¨–ö–ò–ô –¥–ª—è 19K —Å—Ç—Ä–æ–∫!
```

**–í–ª–∏—è–Ω–∏–µ:** 190 –∏—Ç–µ—Ä–∞—Ü–∏–π –≤–º–µ—Å—Ç–æ 38 (–ø—Ä–∏ batchSize = 500).

---

## –ü—Ä–æ–±–ª–µ–º—ã —Å—Ä–µ–¥–Ω–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞

### 9. –ò–∑–ª–∏—à–Ω—è—è –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

**–§–∞–π–ª:** `TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∏:** 1391-1392, 1444-1445

`rebuildIndexes()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö.

### 10. –ù–µ–ø–æ–ª–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π –≤–∞–ª—é—Ç

**–§–∞–π–ª:** `TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∏:** 62-64

–ö—ç—à `convertedAmountsCache` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–≤—Å–µ–º–µ—Å—Ç–Ω–æ.

### 11. SwiftUI re-renders –∫–∞—Å–∫–∞–¥

**–§–∞–π–ª:** `HistoryView.swift`
**–°—Ç—Ä–æ–∫–∏:** 96-123

–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ `onChange` –≤—ã–∑—ã–≤–∞—é—Ç `updateTransactions()` –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ.

### 12. –ù–µ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–∏–∫–∞—Ç—ã

**–§–∞–π–ª:** `TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∏:** 326-329

–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –≤–º–µ—Å—Ç–æ SQL.

### 13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ lazy evaluation

**–§–∞–π–ª:** `TransactionFilterService.swift`

–§—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `[Transaction]` –≤–º–µ—Å—Ç–æ `LazyFilterSequence`.

### 14. –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π displayMonthsRange

**–§–∞–π–ª:** `TransactionsViewModel.swift`
**–°—Ç—Ä–æ–∫–∞:** 21

`displayMonthsRange = 12` –∑–∞–≥—Ä—É–∂–∞–µ—Ç ~99.6% –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

## –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

### Core Data Layer

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –ü—Ä–æ–±–ª–µ–º—ã |
|-----------|------------------|----------|
| **–ú–æ–¥–µ–ª—å (.xcdatamodel)** | –ë–∞–∑–æ–≤–∞—è | –ù–µ—Ç fetch indexes |
| **CoreDataStack** | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π | –ù–µ—Ç background context optimization |
| **CoreDataRepository** | –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π | –ù–µ—Ç batch size, –Ω–µ—Ç prefetching |

### ViewModel Layer

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –ü—Ä–æ–±–ª–µ–º—ã |
|-----------|------------------|----------|
| **TransactionsViewModel** | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å—ë –≤ –ø–∞–º—è—Ç—å | Memory overhead, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ fetches |
| **TransactionFilterService** | –°–æ–∑–¥–∞—ë—Ç –∫–æ–ø–∏–∏ –º–∞—Å—Å–∏–≤–æ–≤ | –ù–µ—Ç lazy evaluation |
| **TransactionGroupingService** | –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π | –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –≤—Å–µ 19202 |
| **BalanceCalculator** | Actor-based | –•–æ—Ä–æ—à–æ |

### UI Layer

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ | –ü—Ä–æ–±–ª–µ–º—ã |
|-----------|------------------|----------|
| **HistoryView** | –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ onChange –ø–µ—Ä–µ—Ñ–∏–ª—å—Ç—Ä–æ–≤–∫–∏ |
| **TransactionPaginationManager** | –†–∞–±–æ—Ç–∞–µ—Ç | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ–ª–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ |
| **ContentView** | –•–æ—Ä–æ—à–æ | –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã |

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)

#### 1.1 –î–æ–±–∞–≤–∏—Ç—å Fetch Indexes

```xml
<!-- –í AIFinanceManager.xcdatamodel -->
<entity name="TransactionEntity">
    <fetchIndex name="byDateIndex">
        <fetchIndexElement property="date" type="Binary" order="descending"/>
    </fetchIndex>
    <fetchIndex name="byCategoryIndex">
        <fetchIndexElement property="category" type="Binary" order="ascending"/>
    </fetchIndex>
    <fetchIndex name="byTypeIndex">
        <fetchIndexElement property="type" type="Binary" order="ascending"/>
    </fetchIndex>
</entity>
```

#### 1.2 –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ saveTransactionsSync –Ω–∞ Background Context

```swift
func saveTransactionsAsync(_ transactions: [Transaction]) async throws {
    try await withCheckedThrowingContinuation { continuation in
        let backgroundContext = stack.container.newBackgroundContext()
        backgroundContext.perform {
            do {
                // –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ —Ñ–æ–Ω–µ
                try self.performBatchSave(transactions, in: backgroundContext)
                try backgroundContext.save()
                continuation.resume()
            } catch {
                continuation.resume(throwing: error)
            }
        }
    }
}
```

#### 1.3 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å Lazy Loading

```swift
// –ù–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
protocol PaginatedDataSource {
    func loadPage(offset: Int, limit: Int) async -> [Transaction]
    func totalCount() async -> Int
}

// –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ CoreDataRepository
extension CoreDataRepository: PaginatedDataSource {
    func loadPage(offset: Int, limit: Int) async -> [Transaction] {
        let request = TransactionEntity.fetchRequest()
        request.fetchOffset = offset
        request.fetchLimit = limit
        request.fetchBatchSize = min(limit, 100)
        request.sortDescriptors = [NSSortDescriptor(key: "date", ascending: false)]
        // ...
    }
}
```

### –≠—Ç–∞–ø 2: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (2-3 –¥–Ω—è)

#### 2.1 –î–æ–±–∞–≤–∏—Ç—å Batch Size –∏ Prefetching

```swift
func loadTransactions(dateRange: DateInterval? = nil) -> [Transaction] {
    let request = TransactionEntity.fetchRequest()
    request.fetchBatchSize = 100  // –î–û–ë–ê–í–ò–¢–¨
    request.relationshipKeyPathsForPrefetching = ["account"]  // –î–û–ë–ê–í–ò–¢–¨
    // ...
}
```

#### 2.2 –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Fetch –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```swift
class TransactionCache {
    private var cache: [String: CacheEntry] = [:]
    private let maxAge: TimeInterval = 60  // 1 –º–∏–Ω—É—Ç–∞

    struct CacheEntry {
        let transactions: [Transaction]
        let timestamp: Date
    }

    func get(key: String) -> [Transaction]? {
        guard let entry = cache[key],
              Date().timeIntervalSince(entry.timestamp) < maxAge else {
            return nil
        }
        return entry.transactions
    }
}
```

#### 2.3 –£–≤–µ–ª–∏—á–∏—Ç—å Batch Size –≤ CSV Import

```swift
// CSVImportService.swift
let batchSize = 500  // –ë—ã–ª–æ 100
```

#### 2.4 –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å HistoryView onChange

```swift
// –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ onChange –≤ –æ–¥–∏–Ω debounced handler
@State private var needsUpdate = false

.onChange(of: timeFilterManager.currentFilter) { _, _ in
    needsUpdate = true
}
.onChange(of: transactionsViewModel.allTransactions) { _, _ in
    needsUpdate = true
}
.task(id: needsUpdate) {
    if needsUpdate {
        try? await Task.sleep(nanoseconds: 100_000_000)  // 100ms debounce
        await updateTransactions()
        needsUpdate = false
    }
}
```

### –≠—Ç–∞–ø 3: –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (3-4 –¥–Ω—è)

#### 3.1 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Lazy Sequences

```swift
// TransactionFilterService.swift
func filterByCategories(
    _ transactions: [Transaction],
    categories: Set<String>
) -> LazyFilterSequence<[Transaction]> {
    return transactions.lazy.filter { categories.contains($0.category) }
}
```

#### 3.2 –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ü–æ–∏—Å–∫ –≤ SQL –ü—Ä–µ–¥–∏–∫–∞—Ç—ã

```swift
// –í–º–µ—Å—Ç–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ –ø–∞–º—è—Ç–∏:
let predicate = NSPredicate(
    format: "descriptionText CONTAINS[cd] %@ OR category CONTAINS[cd] %@",
    searchText, searchText
)
request.predicate = predicate
```

#### 3.3 –£–º–µ–Ω—å—à–∏—Ç—å displayMonthsRange

```swift
// TransactionsViewModel.swift
var displayMonthsRange: Int = 3  // –ë—ã–ª–æ 12
```

---

## –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –ù–µ–¥–µ–ª—è 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

| –î–µ–Ω—å | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª—ã | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|--------|-------|---------------------|
| 1 | –î–æ–±–∞–≤–∏—Ç—å fetch indexes | `.xcdatamodel` | 10-50x —É—Å–∫–æ—Ä–µ–Ω–∏–µ fetch |
| 1-2 | Background context –¥–ª—è save | `CoreDataRepository.swift` | –ù–µ—Ç UI freeze –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ |
| 2-3 | Lazy loading –≤ ViewModel | `TransactionsViewModel.swift` | -70% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ |

### –ù–µ–¥–µ–ª—è 2: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

| –î–µ–Ω—å | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª—ã | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|--------|-------|---------------------|
| 1 | Batch size + prefetching | `CoreDataRepository.swift` | -50% –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ |
| 2 | –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ fetches | –ù–æ–≤—ã–π `TransactionCache.swift` | -80% –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| 3 | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è CSV import | `CSVImportService.swift` | 5x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ |
| 4 | Debounce –≤ HistoryView | `HistoryView.swift` | -90% –ª–∏—à–Ω–∏—Ö re-renders |

### –ù–µ–¥–µ–ª—è 3: –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

| –î–µ–Ω—å | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª—ã | –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç |
|------|--------|-------|---------------------|
| 1-2 | Lazy sequences | `TransactionFilterService.swift` | -60% –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏ |
| 3 | SQL –ø—Ä–µ–¥–∏–∫–∞—Ç—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ | `TransactionsViewModel.swift` | 10x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ |
| 4 | –û–±—â–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ | –í—Å–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã | –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å |

---

## –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (19202 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|------------------|
| –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ | ~3-5 —Å–µ–∫ |
| –û—Ç–∫—Ä—ã—Ç–∏–µ HistoryView | ~2-3 —Å–µ–∫ |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ | ~1-2 —Å–µ–∫ |
| –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ | –õ–∞–≥–∏, —Ñ—Ä–∏–∑—ã |
| –ü–∏–∫–æ–≤–∞—è –ø–∞–º—è—Ç—å | ~50 –ú–ë |
| –ò–º–ø–æ—Ä—Ç 19K CSV | ~30-60 —Å–µ–∫ —Å UI freeze |

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ü–µ–ª—å)

| –ú–µ—Ç—Ä–∏–∫–∞ | –û–∂–∏–¥–∞–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|-------------------|-----------|
| –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ | < 1 —Å–µ–∫ | **3-5x** |
| –û—Ç–∫—Ä—ã—Ç–∏–µ HistoryView | < 0.5 —Å–µ–∫ | **4-6x** |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ | < 0.3 —Å–µ–∫ | **3-6x** |
| –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ | 60 FPS, –ø–ª–∞–≤–Ω–æ | **‚àû** |
| –ü–∏–∫–æ–≤–∞—è –ø–∞–º—è—Ç—å | < 20 –ú–ë | **2.5x** |
| –ò–º–ø–æ—Ä—Ç 19K CSV | < 10 —Å–µ–∫, –±–µ–∑ freeze | **3-6x** |

### –§–æ—Ä–º—É–ª–∞ ROI

```
–¢–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
- 3-5 —Å–µ–∫ √ó –∫–æ–ª-–≤–æ –∑–∞–ø—É—Å–∫–æ–≤/–¥–µ–Ω—å = –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- UI freeze = –ø–ª–æ—Ö–æ–π UX = –æ—Ç—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–ª–∏–∫ = –ª—É—á—à–∏–π UX = —É–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å 50K+ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π = –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
```

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### A. –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| ‚Ññ | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å | Impact |
|---|----------|------|--------|------------|--------|
| 1 | –ù–µ—Ç fetch indexes | `.xcdatamodel` | 104-122 | üî¥ | 10-100x –º–µ–¥–ª–µ–Ω–Ω–µ–µ fetch |
| 2 | –í—Å—ë –≤ –ø–∞–º—è—Ç–∏ | `TransactionsViewModel.swift` | 14, 1360 | üî¥ | ~50 –ú–ë RAM |
| 3 | Sync –Ω–∞ main thread | `CoreDataRepository.swift` | 259-315 | üî¥ | 800-1400–º—Å freeze |
| 4 | –ù–µ—Ç batch size | `CoreDataRepository.swift` | 41-54 | üü† | 2-3x –º–µ–¥–ª–µ–Ω–Ω–µ–µ |
| 5 | –ù–µ—Ç prefetching | `CoreDataRepository.swift` | 41-54 | üü† | N+1 –ø—Ä–æ–±–ª–µ–º–∞ |
| 6 | –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ fetches | `TransactionsViewModel.swift` | 1360-1379 | üü† | 3x –ª–∏—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ |
| 7 | –ö–æ–ø–∏–∏ –º–∞—Å—Å–∏–≤–æ–≤ | `TransactionsViewModel.swift` | 267-294 | üü† | ~30 –ú–ë temp |
| 8 | –ú–∞–ª—ã–π batch –≤ CSV | `CSVImportService.swift` | 115 | üü† | 190 vs 38 –∏—Ç–µ—Ä–∞—Ü–∏–π |
| 9 | –î–≤–æ–π–Ω–æ–π rebuildIndexes | `TransactionsViewModel.swift` | 1391-1445 | üü° | –õ–∏—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ |
| 10 | –ù–µ–ø–æ–ª–Ω—ã–π –∫—ç—à –≤–∞–ª—é—Ç | `TransactionsViewModel.swift` | 62-64 | üü° | –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ |
| 11 | –ö–∞—Å–∫–∞–¥ onChange | `HistoryView.swift` | 96-123 | üü° | 10-20 –ª–∏—à–Ω–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–π |
| 12 | –ü–æ–∏—Å–∫ –≤ –ø–∞–º—è—Ç–∏ | `TransactionsViewModel.swift` | 326-329 | üü° | O(n) –≤–º–µ—Å—Ç–æ SQL |
| 13 | –ù–µ—Ç lazy sequences | `TransactionFilterService.swift` | ‚Äî | üü° | –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã |
| 14 | displayMonthsRange=12 | `TransactionsViewModel.swift` | 21 | üü° | 99.6% –¥–∞–Ω–Ω—ã—Ö |

### B. –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `/docs/PERFORMANCE_ANALYSIS.md` ‚Äî –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∞–Ω–∞–ª–∏–∑
- `/docs/PERFORMANCE_OPTIMIZATION_PLAN.md` ‚Äî –ø–ª–∞–Ω –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- `/docs/HistoryView_Analysis_Report.md` ‚Äî –∞–Ω–∞–ª–∏–∑ HistoryView
- `/docs/FINAL_Optimization_Report.md` ‚Äî –æ—Ç—á—ë—Ç –ø–æ TransactionsViewModel
- `/docs/CORE_DATA_MIGRATION_COMPLETE.md` ‚Äî –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ Core Data

---

## Changelog: –í–Ω–µ—Å—ë–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 2026-01-28: –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ ‚úÖ

#### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã Fetch Indexes –≤ Core Data –º–æ–¥–µ–ª—å
**–§–∞–π–ª:** `AIFinanceManager.xcdatamodel/contents`
- `byDateIndex` ‚Äî –∏–Ω–¥–µ–∫—Å –ø–æ –¥–∞—Ç–µ (descending)
- `byCategoryIndex` ‚Äî –∏–Ω–¥–µ–∫—Å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `byTypeIndex` ‚Äî –∏–Ω–¥–µ–∫—Å –ø–æ —Ç–∏–ø—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- `byDateAndCategoryIndex` ‚Äî —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–∞—Ç–∞ + –∫–∞—Ç–µ–≥–æ—Ä–∏—è
- `byDateAndTypeIndex` ‚Äî —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–∞—Ç–∞ + —Ç–∏–ø

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** 10-100x —É—Å–∫–æ—Ä–µ–Ω–∏–µ fetch –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

#### 2. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω saveTransactionsSync
**–§–∞–π–ª:** `CoreDataRepository.swift`
- –ü–µ—Ä–µ–Ω–µ—Å—ë–Ω –Ω–∞ `backgroundContext` –≤–º–µ—Å—Ç–æ `viewContext`
- –î–æ–±–∞–≤–ª–µ–Ω–æ batch —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 500 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –î–æ–±–∞–≤–ª–µ–Ω `context.reset()` –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –º–µ–∂–¥—É batch'–∞–º–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** UI –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ 19K —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

#### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã fetchBatchSize –∏ prefetching
**–§–∞–π–ª:** `CoreDataRepository.swift`
- `request.fetchBatchSize = 100` ‚Äî –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
- `request.relationshipKeyPathsForPrefetching = ["account"]` ‚Äî —Ä–µ—à–µ–Ω–∏–µ N+1 –ø—Ä–æ–±–ª–µ–º—ã

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** 2-3x —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏, –º–µ–Ω—å—à–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

#### 4. ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω CSV –∏–º–ø–æ—Ä—Ç
**–§–∞–π–ª:** `CSVImportService.swift`
- –£–≤–µ–ª–∏—á–µ–Ω `batchSize` —Å 100 –¥–æ 500

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** 5x –º–µ–Ω—å—à–µ –∏—Ç–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ 19K —Å—Ç—Ä–æ–∫

#### 5. ‚úÖ –£–º–µ–Ω—å—à–µ–Ω displayMonthsRange
**–§–∞–π–ª:** `TransactionsViewModel.swift`
- –£–º–µ–Ω—å—à–µ–Ω —Å 12 –¥–æ 6 –º–µ—Å—è—Ü–µ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** ~50% –º–µ–Ω—å—à–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ

#### 6. ‚úÖ –£–±—Ä–∞–Ω –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è –≤—ã–∑–æ–≤ rebuildIndexes
**–§–∞–π–ª:** `TransactionsViewModel.swift`
- –£–¥–∞–ª—ë–Ω –≤—ã–∑–æ–≤ `rebuildIndexes()` –≤ `loadOtherData()` (—Å—Ç—Ä–æ–∫–∞ 1447)
- –û—Å—Ç–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ –≤—ã–∑–æ–≤ –≤ background task –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å—Ç—Ä–æ–∫–∞ 1394)

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª –∫–æ–≥–¥–∞ `allTransactions` –±—ã–ª –µ—â—ë –ø—É—Å—Ç—ã–º (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥—ë—Ç –≤ —Ñ–æ–Ω–µ), –ø–æ—ç—Ç–æ–º—É –æ–Ω –±—ã–ª –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω.

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** –≠–∫–æ–Ω–æ–º–∏—è –æ–¥–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –≤—Å–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

#### 7. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ accountsById —Å–ª–æ–≤–∞—Ä—è
**–§–∞–π–ª:** `TransactionsViewModel.swift`
- –î–æ–±–∞–≤–ª–µ–Ω `cachedAccountsById` –∏ `accountsCacheInvalidated` —Ñ–ª–∞–≥
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `getAccountsById()` –¥–ª—è –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—ç—à–∞
- –ó–∞–º–µ–Ω–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–≤–∞—Ä—è –≤ `filterTransactionsForHistory` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç:** O(1) –≤–º–µ—Å—Ç–æ O(n) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–≤–∞—Ä—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–∏—Å–∫–µ

---

**–ê–≤—Ç–æ—Ä –∞–Ω–∞–ª–∏–∑–∞:** Claude Opus 4.5
**–î–∞—Ç–∞:** 2026-01-28
**–í–µ—Ä—Å–∏—è:** 1.3 (–¥–æ–±–∞–≤–ª–µ–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ accountsById)
