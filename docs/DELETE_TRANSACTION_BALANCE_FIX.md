# Delete Transaction Balance Fix ‚úÖ

**Date:** 2026-01-23  
**Status:** ‚úÖ Fixed  
**Issue:** –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—Å–µ –±–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤ –æ–±–Ω—É–ª–∏–ª–∏—Å—å

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
2. **–í—Å–µ –±–∞–ª–∞–Ω—Å—ã —Å—á–µ—Ç–æ–≤ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è 0.0** üò±
3. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ—Ä—è–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ

### Impact:
- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è** –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–µ—Ä—è–µ—Ç –¥–æ–≤–µ—Ä–∏–µ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üîç Root Cause Analysis

### –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤

#### –ù–æ—Ä–º–∞–ª—å–Ω—ã–π flow (–æ–∂–∏–¥–∞–µ–º—ã–π):

```
–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    ‚Üì
recalculateAccountBalances()
    ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –±–µ–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    ‚Üí –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å AccountsViewModel
    ‚Üí ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Core Data
    ‚Üì
UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏
```

#### –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π flow (—Å –±–∞–≥–æ–º):

```
–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    ‚Üì
recalculateAccountBalances()
    ‚Üí –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã ‚úÖ
    ‚Üí accountsVM.syncAccountBalances(accounts) ‚úÖ
    ‚Üí ‚ùå –ù–ï –°–û–•–†–ê–ù–Ø–ï–¢ –≤ Core Data!
    ‚Üì
saveToStorage() (async)
    ‚Üí –°–æ—Ö—Ä–∞–Ω—è–µ—Ç TransactionsViewModel.accounts
    ‚Üí ‚ùå –ù–û AccountsViewModel.accounts –ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è!
    ‚Üì
UI –≤—ã–∑—ã–≤–∞–µ—Ç reloadFromStorage()
    ‚Üí –ó–∞–≥—Ä—É–∂–∞–µ—Ç –°–¢–ê–†–´–ï –±–∞–ª–∞–Ω—Å—ã –∏–∑ Core Data
    ‚Üí ‚ùå –ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω—É–ª–∏–ª–∏—Å—å / –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ!
```

### –ì–¥–µ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø–æ–ª–æ–º–∫–∞

**–§–∞–π–ª:** `TransactionsViewModel.swift`  
**–ú–µ—Ç–æ–¥:** `recalculateAccountBalances()` (—Å—Ç—Ä–æ–∫–∞ 1701-1707)

```swift
// ‚ùå –°—Ç–∞—Ä—ã–π –∫–æ–¥
if let accountsVM = accountsViewModel {
    print("üîó [BALANCE] Syncing balances with AccountsViewModel")
    accountsVM.syncAccountBalances(accounts)
    // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –±–∞–ª–∞–Ω—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø–∞–º—è—Ç–∏,
    // –Ω–æ –ù–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Core Data!
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ

1. **`syncAccountBalances()`** –æ–±–Ω–æ–≤–ª—è–µ—Ç `AccountsViewModel.accounts` –≤ –ø–∞–º—è—Ç–∏
2. **–ù–û** –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Core Data
3. `deleteTransaction()` –≤—ã–∑—ã–≤–∞–µ—Ç `saveToStorage()` **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**
4. UI –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å `reloadFromStorage()` **–î–û** –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è async save
5. `reloadFromStorage()` –∑–∞–≥—Ä—É–∂–∞–µ—Ç **—Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ** –∏–∑ Core Data
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –±–∞–ª–∞–Ω—Å—ã –æ–±–Ω—É–ª—è—é—Ç—Å—è –∏–ª–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏!

### Race Condition

```
Thread 1 (UI):                    Thread 2 (Background Save):
deleteTransaction() ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì                           ‚îÇ
recalculateAccountBalances()    ‚îÇ
    ‚Üì                           ‚îÇ
syncAccountBalances() ‚úÖ        ‚îÇ
    ‚Üì                           ‚îÇ
saveToStorage() (async) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚Üí Task.detached {
    ‚Üì                           ‚îÇ       ...
UI calls reloadFromStorage() ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚Üí    repository.saveAccounts()
    ‚Üì                           ‚îÇ       (–º–æ–∂–µ—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è –ø–æ–∑–∂–µ!)
Loads OLD data from Core Data ‚ùå ‚îÇ   }
    ‚Üì                           ‚îÇ
Balances reset to 0! üò±         ‚îÇ
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –û–±–Ω–æ–≤–ª–µ–Ω `TransactionsViewModel.recalculateAccountBalances()`

–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `saveAllAccountsSync()` —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `syncAccountBalances()`:

```swift
// ‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ (—Å—Ç—Ä–æ–∫–∞ 1701+)
if let accountsVM = accountsViewModel {
    print("üîó [BALANCE] Syncing balances with AccountsViewModel")
    accountsVM.syncAccountBalances(accounts)
    
    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –≤ Core Data —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ!
    print("üíæ [BALANCE] Saving updated balances to Core Data")
    accountsVM.saveAllAccountsSync()
} else {
    print("‚ö†Ô∏è [BALANCE] AccountsViewModel is nil, skipping balance sync")
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **`syncAccountBalances()`** - –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤ –ø–∞–º—è—Ç–∏
2. **`saveAllAccountsSync()`** - **–°–†–ê–ó–£** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Core Data (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
3. `reloadFromStorage()` –≤ UI –∑–∞–≥—Ä—É–∑–∏—Ç **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã**
4. **–ù–µ—Ç race condition** - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –î–û –ª—é–±–æ–≥–æ reload

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è

| –ê—Å–ø–µ–∫—Ç | Async Save | Sync Save (–†–µ—à–µ–Ω–∏–µ) |
|--------|------------|---------------------|
| **–ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è** | ‚ùå –ù–µ—Ç (–º–æ–∂–µ—Ç –Ω–µ —É—Å–ø–µ—Ç—å) | ‚úÖ –î–∞ (—Å—Ä–∞–∑—É) |
| **Race conditions** | ‚ùå –í–æ–∑–º–æ–∂–Ω—ã | ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã |
| **Reload –≤ UI** | ‚ùå –ú–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ä–æ–µ | ‚úÖ –í—Å–µ–≥–¥–∞ —Å–≤–µ–∂–µ–µ |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | ‚ö° –ë—ã—Å—Ç—Ä–µ–µ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç) | üê¢ –ß—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ |
| **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** | ‚ö†Ô∏è –°—Ä–µ–¥–Ω—è—è | ‚úÖ –í—ã—Å–æ–∫–∞—è |

–î–ª—è **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π** (—É–¥–∞–ª–µ–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π) –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏!

---

## üìä –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### –§–∞–π–ª: `TransactionsViewModel.swift`

**–ú–µ—Ç–æ–¥:** `recalculateAccountBalances()`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `accountsVM.saveAllAccountsSync()` –ø–æ—Å–ª–µ `syncAccountBalances()`

**–°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ:** 4

### –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

–¢–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞—é—Ç:

| –û–ø–µ—Ä–∞—Ü–∏—è | –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è | –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
|----------|----------------|-------------------|
| –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | ‚ùå –ë–∞–ª–∞–Ω—Å—ã –æ–±–Ω—É–ª—è—é—Ç—Å—è | ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è |
| –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Å–±–∏—Ç—å—Å—è | ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ |
| –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ | ‚ö†Ô∏è –ú–æ–∂–µ—Ç —Å–±–∏—Ç—å—Å—è | ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ |
| –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç CSV | ‚ö†Ô∏è –ú–æ–≥ —Å–±–∏—Ç—å—Å—è | ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ |
| –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è | ‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–∞–ª —Å—Ç–∞—Ä–æ–µ | ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–≤–µ–∂–µ–µ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Test Case 1: –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
2. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Kaspi Gold: 51,409.84 ‚Ç∏")
3. –£–¥–∞–ª–∏—Ç—å –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Ä–∞—Å—Ö–æ–¥–∞ –Ω–∞ 5,000 ‚Ç∏
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å** - –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å 56,409.84 ‚Ç∏
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å —Å–Ω–æ–≤–∞** - –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è 56,409.84 ‚Ç∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
–î–æ —É–¥–∞–ª–µ–Ω–∏—è:
üí∞ Kaspi Gold: 51,409.84 ‚Ç∏
üìù –ü—Ä–æ–¥—É–∫—Ç—ã -5,000 ‚Ç∏

‚Üì (—É–¥–∞–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é)

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:
üí∞ Kaspi Gold: 56,409.84 ‚Ç∏  ‚Üê ‚úÖ –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è –Ω–∞ 5,000 ‚Ç∏!

‚Üì (–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞:
üí∞ Kaspi Gold: 56,409.84 ‚Ç∏  ‚Üê ‚úÖ –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è!
```

**–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**

```
–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è:
üí∞ Kaspi Gold: 0.0 ‚Ç∏  ‚Üê ‚ùå –û–±–Ω—É–ª–∏–ª—Å—è!
```

### Test Case 2: –£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞

**–®–∞–≥–∏:**
1. –ë–∞–ª–∞–Ω—Å –¥–æ: Jusan: 100,000 ‚Ç∏, Kaspi: 50,000 ‚Ç∏
2. –£–¥–∞–ª–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥ "Jusan ‚Üí Kaspi: 10,000 ‚Ç∏"
3. –û–∂–∏–¥–∞–µ–º—ã–µ –±–∞–ª–∞–Ω—Å—ã: Jusan: 110,000 ‚Ç∏, Kaspi: 40,000 ‚Ç∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –û–±–∞ –±–∞–ª–∞–Ω—Å–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

### Test Case 3: –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞

**–®–∞–≥–∏:**
1. –ë–∞–ª–∞–Ω—Å –¥–æ: Jusan: 450,000 ‚Ç∏
2. –£–¥–∞–ª–∏—Ç—å –¥–æ—Ö–æ–¥ "–ó–∞—Ä–ø–ª–∞—Ç–∞: +350,000 ‚Ç∏"
3. –û–∂–∏–¥–∞–µ–º—ã–π –±–∞–ª–∞–Ω—Å: Jusan: 100,000 ‚Ç∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ë–∞–ª–∞–Ω—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

---

## üéØ Success Criteria

| –ö—Ä–∏—Ç–µ—Ä–∏–π | –°—Ç–∞—Ç—É—Å |
|----------|--------|
| –ë–∞–ª–∞–Ω—Å—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ | ‚úÖ |
| –ë–∞–ª–∞–Ω—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Core Data | ‚úÖ |
| –ë–∞–ª–∞–Ω—Å—ã –ù–ï –æ–±–Ω—É–ª—è—é—Ç—Å—è | ‚úÖ |
| –ë–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã –ø–æ—Å–ª–µ reload | ‚úÖ |
| –ù–µ—Ç race conditions | ‚úÖ |
| –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | ‚úÖ |

---

## üìö Technical Details

### Flow Diagram (–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

```
deleteTransaction()
    ‚Üì
1. allTransactions.removeAll { $0.id == transaction.id }
    ‚Üì
2. recalculateAccountBalances()
    ‚Üì
3. Calculate new balances
    initialBalance[accountId] + balanceChanges[accountId]
    ‚Üì
4. Update TransactionsViewModel.accounts
    accounts = newAccounts
    ‚Üì
5. Sync with AccountsViewModel
    accountsVM.syncAccountBalances(accounts)
    ‚Üì
6. ‚úÖ Save to Core Data (SYNC!)
    accountsVM.saveAllAccountsSync()
        ‚Üì
        coreDataRepo.saveAccountsSync(accounts)
        ‚Üì
        context.save()  ‚Üê –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ!
    ‚Üì
7. Save transactions (async - can be later)
    saveToStorage()
    ‚Üì
8. UI reloads
    reloadFromStorage()
    ‚Üì
9. ‚úÖ Loads CORRECT balances from Core Data!
```

### Why Sync is Critical Here

**–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π, –∫–æ—Ç–æ—Ä—ã–µ:**
1. –ò–∑–º–µ–Ω—è—é—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
2. –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
3. –ú–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–µ

**–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:**
1. –§–æ–Ω–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
2. –ù–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –ú–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º

---

## üîÆ Related Issues

### –î—Ä—É–≥–∏–µ –º–µ—Å—Ç–∞, –≥–¥–µ –Ω—É–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞

1. ‚úÖ **`addTransaction()`** - —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `recalculateAccountBalances()`
2. ‚úÖ **`updateTransaction()`** - —É–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `recalculateAccountBalances()`
3. ‚úÖ **CSV Import** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `saveAccountsSync()` –≤ –∫–æ–Ω—Ü–µ
4. ‚ö†Ô∏è **Recurring transactions generation** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### Recommendation

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ **–≤–µ–∑–¥–µ**, –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `recalculateAccountBalances()`, –±–∞–ª–∞–Ω—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Core Data.

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å `saveAllAccountsSync()` **–≤–Ω—É—Ç—Ä—å** `recalculateAccountBalances()`:

```swift
func recalculateAccountBalances() {
    // ... –ø–µ—Ä–µ—Å—á–µ—Ç –±–∞–ª–∞–Ω—Å–æ–≤
    
    // –í—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    if let accountsVM = accountsViewModel {
        accountsVM.syncAccountBalances(accounts)
        accountsVM.saveAllAccountsSync()
    }
}
```

–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–∞–ª–∞–Ω—Å—ã **–≤—Å–µ–≥–¥–∞** —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞.

---

## ‚ö†Ô∏è Known Limitations

### Performance Impact

–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI –Ω–∞ ~10-50ms –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—á–µ—Ç–æ–≤ (–æ–±—ã—á–Ω–æ 5-20)
- –°–∫–æ—Ä–æ—Å—Ç–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ Core Data

**–î–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:** –Ω–µ–∑–∞–º–µ—Ç–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–î–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (100+ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π):** –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–º–µ—Ç–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞—Ç—á–∏–Ω–≥ (–∫–∞–∫ –≤ CSV import)
- –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å progress indicator
- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ

---

## ‚úÖ Conclusion

–ü—Ä–æ–±–ª–µ–º–∞ **–ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞**:

- ‚úÖ **–ë–∞–ª–∞–Ω—Å—ã –Ω–µ –æ–±–Ω—É–ª—è—é—Ç—Å—è** - —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ Core Data
- ‚úÖ **–ù–µ—Ç race conditions** - –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –î–û reload
- ‚úÖ **–î–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è** - –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- ‚úÖ **Production ready** - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ –≤—Å–µ—Ö —Ç–∏–ø–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞!**

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2026-01-23  
**–°—Ç—Ä–æ–∫ –∫–æ–¥–∞:** 4 —Å—Ç—Ä–æ–∫–∏ –≤ 1 —Ñ–∞–π–ª–µ  
**Impact:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **Fixed!** üéâ
