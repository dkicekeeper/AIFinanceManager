# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –û–±–Ω—É–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ª—é–±–æ–≥–æ —Å—á–µ—Ç–∞ —É –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ –æ–±–Ω—É–ª—è—é—Ç—Å—è –±–∞–ª–∞–Ω—Å—ã. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

## –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ

1. –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—á–µ—Ç–æ–≤ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏
2. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–∞ —ç—Ç–∏ —Å—á–µ—Ç–∞
3. –£–¥–∞–ª–∏—Ç—å –æ–¥–∏–Ω –∏–∑ —Å—á–µ—Ç–æ–≤
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –£ –≤—Å–µ—Ö –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—á–µ—Ç–æ–≤ –±–∞–ª–∞–Ω—Å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è 0
5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
6. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ë–∞–ª–∞–Ω—Å—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ (–û–ë–ù–û–í–õ–ï–ù–û)

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ `CoreDataRepository`, –Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫–∞–∑–∞–ª–æ, —á—Ç–æ –Ω–∞—Å—Ç–æ—è—â–∞—è –∫–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –Ω–∞—Ö–æ–¥–∏–ª–∞—Å—å –≤ `BalanceCoordinator`.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–∞–ª–∞–Ω—Å–∞ —Å—á–µ—Ç–æ–≤

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:

1. **–í –ø–∞–º—è—Ç–∏** (—Ç–µ–∫—É—â–∏–π, –∞–∫—Ç—É–∞–ª—å–Ω—ã–π):
   - `BalanceCoordinator.balances: [String: Double]` - —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

2. **–í Core Data** (–∫–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏):
   - `AccountEntity.balance: Double` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ `Account.initialBalance`

### –ü–æ—Ç–æ–∫ –æ—à–∏–±–∫–∏ (–ù–ê–°–¢–û–Ø–©–ê–Ø –ü–†–ò–ß–ò–ù–ê)

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç —Å—á–µ—Ç
2. `TransactionStore.deleteAccount()` —É–¥–∞–ª—è–µ—Ç —Å—á–µ—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `persistAccounts()`
3. Observer –≤ `AccountsViewModel` –ø–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `accounts` —Ç–µ–ø–µ—Ä—å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞ 1 —Å—á–µ—Ç –º–µ–Ω—å—à–µ
4. –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `setupTransactionStoreObserver()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `syncInitialBalancesToCoordinator()`
5. **–ü–†–û–ë–õ–ï–ú–ê:** `syncInitialBalancesToCoordinator()` –≤—ã–∑—ã–≤–∞–µ—Ç `coordinator.registerAccounts(accounts)`
6. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ `BalanceCoordinator.registerAccounts()`:**
   ```swift
   let initialBalances = Dictionary(uniqueKeysWithValues: accounts.map { ($0.id, $0.initialBalance ?? 0) })
   self.balances = initialBalances  // ‚ùå –ü–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –í–°–ï –±–∞–ª–∞–Ω—Å—ã –Ω—É–ª—è–º–∏!
   ```
7. –î–ª—è —Å—á–µ—Ç–æ–≤ —Å `shouldCalculateFromTransactions = true`, `initialBalance` —Ä–∞–≤–µ–Ω 0
8. `self.balances` **–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è** ‚Üí –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –±–∞–ª–∞–Ω—Å—ã –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ 0
9. UI –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∏–∑ `balances` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 –¥–ª—è –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤
10. –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ `BalanceCoordinator` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

### –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```
Account Creation
---------------
User creates account with initialBalance=1000
  ‚Üì
TransactionStore.addAccount()
  ‚Üì
AccountEntity.balance = 1000  ‚úÖ Correct
  ‚Üì
BalanceCoordinator initializes with balance=1000


After Transactions
-----------------
User adds expense -500
  ‚Üì
BalanceCoordinator calculates: 1000 - 500 = 500
  ‚Üì
balances["account123"] = 500  ‚úÖ Current balance in memory
  ‚Üì
AccountEntity.balance = 1000  ‚ö†Ô∏è Still shows initialBalance in DB


Account Deletion (BEFORE FIX) - REAL BUG
-----------------------------------------
User deletes another account
  ‚Üì
TransactionStore.deleteAccount() removes from array
  ‚Üì
Observer triggers in AccountsViewModel
  ‚Üì
syncInitialBalancesToCoordinator() called
  ‚Üì
coordinator.registerAccounts(accounts) called  ‚ùå HERE!
  ‚Üì
self.balances = [
  "account1": 0,  // was 500
  "account3": 0   // was 2500
]  ‚ùå ALL BALANCES RESET TO initialBalance (which is 0)!
  ‚Üì
UI updates from coordinator.balances  ‚ùå Shows 0 balance
  ‚Üì
App restart ‚Üí BalanceCoordinator recalculates ‚Üí Shows 500  ‚úÖ
```

## –†–µ—à–µ–Ω–∏–µ

### –î–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

#### –≠—Ç–∞–ø 1: CoreDataRepository (–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `CoreDataRepository.swift`

#### 1. –ú–µ—Ç–æ–¥ `saveAccounts()` (—Å—Ç—Ä–æ–∫–∞ 210-222)

**–î–æ:**
```swift
if let existing = existingDict[account.id] {
    // Update existing
    existing.name = account.name
    existing.balance = account.initialBalance ?? 0  // ‚ùå Bug
    existing.currency = account.currency
    existing.logo = account.bankLogo.rawValue
    existing.isDeposit = account.isDeposit
    existing.bankName = account.depositInfo?.bankName
}
```

**–ü–æ—Å–ª–µ:**
```swift
if let existing = existingDict[account.id] {
    // Update existing
    existing.name = account.name
    // ‚ö†Ô∏è CRITICAL FIX: Don't overwrite balance here - it's managed by BalanceCoordinator
    // Only update balance when creating new accounts
    // existing.balance = account.initialBalance ?? 0  // ‚ùå This was causing balance reset
    existing.currency = account.currency
    existing.logo = account.bankLogo.rawValue
    existing.isDeposit = account.isDeposit
    existing.bankName = account.depositInfo?.bankName
}
```

#### 2. –ú–µ—Ç–æ–¥ `saveAccountsSync()` (—Å—Ç—Ä–æ–∫–∞ 376-388)

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º–µ—Ç–æ–¥–∞.

#### –≠—Ç–∞–ø 2: BalanceCoordinator (–ù–ê–°–¢–û–Ø–©–ï–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `BalanceCoordinator.swift`:**

**–î–æ:**
```swift
func registerAccounts(_ accounts: [Account]) async {
    let accountBalances = accounts.map { AccountBalance.from($0) }
    store.registerAccounts(accountBalances)

    let initialBalances = Dictionary(uniqueKeysWithValues: accounts.map {
        ($0.id, $0.initialBalance ?? 0)
    })
    cache.setBalances(initialBalances)

    self.balances = initialBalances  // ‚ùå Bug - overwrites ALL balances!
}
```

**–ü–æ—Å–ª–µ:**
```swift
func registerAccounts(_ accounts: [Account]) async {
    let accountBalances = accounts.map { AccountBalance.from($0) }
    store.registerAccounts(accountBalances)

    // ‚ö†Ô∏è CRITICAL FIX: Only initialize balances for NEW accounts
    var updatedBalances = self.balances  // Preserve existing balances

    for account in accounts {
        // Only set initial balance if account is NOT already registered
        if updatedBalances[account.id] == nil {
            let initialBalance = account.initialBalance ?? 0
            updatedBalances[account.id] = initialBalance
            cache.setBalance(initialBalance, for: account.id)
        }
    }

    self.balances = updatedBalances  // ‚úÖ Preserves existing balances!
}
```

### –õ–æ–≥–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–ü—Ä–∏–Ω—Ü–∏–ø:**
- `BalanceCoordinator.balances` —Å–æ–¥–µ—Ä–∂–∏—Ç **–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ** –±–∞–ª–∞–Ω—Å—ã, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—á–µ—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ) –Ω—É–∂–Ω–æ **—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–∞–ª–∞–Ω—Å—ã
- –¢–æ–ª—å–∫–æ **–Ω–æ–≤—ã–µ** —Å—á–µ—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è —Å `initialBalance`
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—á–µ—Ç–∞ **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç** —Å–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ –±–∞–ª–∞–Ω—Å—ã

**–ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ù–û–í–û–ì–û —Å—á–µ—Ç–∞ `balances[accountId]` —Ä–∞–≤–µ–Ω `nil` ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `initialBalance` ‚úÖ
2. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—á–µ—Ç–æ–≤ `balances[accountId]` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –±–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è ‚úÖ
3. –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è, –Ω–æ –∏—Ö –±–∞–ª–∞–Ω—Å—ã –ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è ‚úÖ
4. `BalanceCoordinator` –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –±–∞–ª–∞–Ω—Å–∞–º–∏ –≤ –ø–∞–º—è—Ç–∏ ‚úÖ

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£–¥–∞–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å 3 —Å—á–µ—Ç–∞ —Å –±–∞–ª–∞–Ω—Å–∞–º–∏ 1000, 2000, 3000
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (—Ä–∞—Å—Ö–æ–¥—ã -500 –Ω–∞ –∫–∞–∂–¥—ã–π)
3. ‚úÖ –¢–µ–∫—É—â–∏–µ –±–∞–ª–∞–Ω—Å—ã: 500, 1500, 2500
4. ‚úÖ –£–¥–∞–ª–∏—Ç—å –≤—Ç–æ—Ä–æ–π —Å—á–µ—Ç
5. ‚úÖ **–û–∂–∏–¥–∞–µ–º–æ:** –ë–∞–ª–∞–Ω—Å—ã –ø–µ—Ä–≤–æ–≥–æ –∏ —Ç—Ä–µ—Ç—å–µ–≥–æ —Å—á–µ—Ç–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è 500 –∏ 2500
6. ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** PASSED - –±–∞–ª–∞–Ω—Å—ã –Ω–µ –æ–±–Ω—É–ª–∏–ª–∏—Å—å

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
1. ‚úÖ –ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ 1 –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. ‚úÖ **–û–∂–∏–¥–∞–µ–º–æ:** –ë–∞–ª–∞–Ω—Å—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (500 –∏ 2500)
3. ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** PASSED

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç —Å initialBalance=5000
2. ‚úÖ **–û–∂–∏–¥–∞–µ–º–æ:** AccountEntity.balance = 5000
3. ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** PASSED

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

–í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–ª–∞–Ω—Å–æ–≤:**
   ```swift
   // In BalanceCoordinator
   func syncBalancesToCoreData() async {
       for (accountId, balance) in balances {
           await repository.updateAccountBalance(accountId: accountId, balance: balance)
       }
   }
   ```

2. **–û—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞:**
   ```swift
   // In CoreDataRepository
   func updateAccountBalance(accountId: String, balance: Double) async {
       // Update only the balance field, not all account properties
   }
   ```

–û–¥–Ω–∞–∫–æ —ç—Ç–∏ —É–ª—É—á—à–µ–Ω–∏—è **–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã**, —Ç–∞–∫ –∫–∞–∫:
- `BalanceCoordinator` –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
- –ë–∞–ª–∞–Ω—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- `AccountEntity.balance` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –Ω–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `AIFinanceManager/Services/Balance/BalanceCoordinator.swift` - **–û–°–ù–û–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- `AIFinanceManager/Services/CoreDataRepository.swift` - –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- `AIFinanceManager/ViewModels/AccountsViewModel.swift` - –≤—ã–∑—ã–≤–∞–µ—Ç `syncInitialBalancesToCoordinator()`
- `AIFinanceManager/ViewModels/TransactionStore.swift` - –≤—ã–∑—ã–≤–∞–µ—Ç `persistAccounts()`
- `AIFinanceManager/CoreData/Entities/AccountEntity+CoreDataClass.swift` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏

## –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 2026-02-10 (–ü–æ–ø—ã—Ç–∫–∞ 1)
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ `CoreDataRepository.saveAccounts()`
- –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å—Ç—Ä–æ–∫–∞ `existing.balance = account.initialBalance ?? 0`
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï —Ä–µ—à–µ–Ω–∞ - –±–∞–ª–∞–Ω—Å—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –æ–±–Ω—É–ª—è–ª–∏—Å—å

### 2026-02-10 (–ü–æ–ø—ã—Ç–∫–∞ 2 - –£–°–ü–ï–•)
- –ù–∞–π–¥–µ–Ω–∞ –Ω–∞—Å—Ç–æ—è—â–∞—è –ø—Ä–∏—á–∏–Ω–∞ –≤ `BalanceCoordinator.registerAccounts()`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å `self.balances` –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–±–ª–µ–º–∞ –†–ï–®–ï–ù–ê ‚úÖ

## –°—Ç–∞—Ç—É—Å

‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û** - –±–∞–ª–∞–Ω—Å –±–æ–ª—å—à–µ –Ω–µ –æ–±–Ω—É–ª—è–µ—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞
‚úÖ **–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û** - –±–∞–ª–∞–Ω—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Core Data, –ø–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω

–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: 2026-02-10

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

### –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –±–∞–≥–∞ –≤—ã—è—Å–Ω–∏–ª–æ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—Å–µ—Ö 36 —Å—á–µ—Ç–æ–≤ –∏–∑ 18,248 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ, —á—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.

### –†–µ—à–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –±–∞–ª–∞–Ω—Å–æ–≤ –≤ Core Data:

#### 1. –ú–µ—Ç–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –≤ `CoreDataRepository.swift`

**–û–¥–∏–Ω–æ—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:**
```swift
func updateAccountBalance(accountId: String, balance: Double) {
    Task.detached(priority: .userInitiated) { [weak self] in
        try await self.saveCoordinator.performSave(operation: "updateAccountBalance") { context in
            let fetchRequest = AccountEntity.fetchRequest()
            fetchRequest.predicate = NSPredicate(format: "id == %@", accountId)
            if let account = try context.fetch(fetchRequest).first {
                account.balance = balance
            }
        }
    }
}
```

**–ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤):**
```swift
func updateAccountBalances(_ balances: [String: Double]) {
    Task.detached(priority: .userInitiated) { [weak self] in
        try await self.saveCoordinator.performSave(operation: "updateAccountBalances") { context in
            let accountIds = Array(balances.keys)
            let fetchRequest = AccountEntity.fetchRequest()
            fetchRequest.predicate = NSPredicate(format: "id IN %@", accountIds)
            let accounts = try context.fetch(fetchRequest)
            for account in accounts {
                if let accountId = account.id, let newBalance = balances[accountId] {
                    account.balance = newBalance
                }
            }
        }
    }
}
```

#### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `BalanceCoordinator.swift`

**–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞:**
```swift
private func persistBalances(_ balances: [String: Double]) {
    guard let coreDataRepo = repository as? CoreDataRepository else { return }
    coreDataRepo.updateAccountBalances(balances)  // ‚úÖ Batch update
}
```

**–í—ã–∑–æ–≤—ã –≤ –º–µ—Ç–æ–¥–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:**
- `processAddTransaction()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `persistBalance()` –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- `processRemoveTransaction()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `persistBalance()` –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
- `processRecalculateAll()` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `persistBalances()` –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –≤—Å–µ—Ö –±–∞–ª–∞–Ω—Å–æ–≤

#### 3. –£–¥–∞–ª–µ–Ω–∏–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤ `AppCoordinator.swift`

**–î–æ:**
```swift
// CRITICAL: Recalculate balances after loading transactions
await balanceCoordinator.recalculateAll(
    accounts: accountsViewModel.accounts,
    transactions: transactionsViewModel.allTransactions
)
```

**–ü–æ—Å–ª–µ:**
```swift
// ‚úÖ OPTIMIZED 2026-02-10: No need to recalculate on launch
// Balances are now persisted to Core Data and loaded correctly during registerAccounts()
#if DEBUG
print("‚úÖ [AppCoordinator] Balances loaded from Core Data - skipping recalculation")
#endif
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
App Launch
----------
1. TransactionStore loads accounts from Core Data
   AccountEntity.balance ‚Üí Account.initialBalance  ‚úÖ Restored from DB

2. BalanceCoordinator.registerAccounts() called
   account.initialBalance ‚Üí balances[accountId]  ‚úÖ Loaded from Core Data

3. UI displays balances  ‚úÖ Instant, no recalculation needed


Transaction Added
----------------
1. BalanceCoordinator.updateForTransaction() called
2. Balance recalculated for affected account(s)
3. persistBalance() saves to Core Data  üíæ
4. UI updates


Account Deleted
--------------
1. TransactionStore.deleteAccount() removes account
2. AccountsViewModel observer triggers
3. BalanceCoordinator.registerAccounts() called
4. Preserves existing balances  ‚úÖ (our bug fix)
5. No recalculation needed
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

- ‚úÖ –ë–∞–ª–∞–Ω—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Core Data –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚úÖ –ü–µ—Ä–µ—Å—á–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- ‚úÖ –ü–∞–∫–µ—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
- ‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

- `AIFinanceManager/ViewModels/AppCoordinator.swift` - —É–¥–∞–ª–µ–Ω `recalculateAll()` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- `AIFinanceManager/Services/Balance/BalanceCoordinator.swift` - –¥–æ–±–∞–≤–ª–µ–Ω—ã `persistBalance()` –∏ `persistBalances()`
- `AIFinanceManager/Services/CoreDataRepository.swift` - –¥–æ–±–∞–≤–ª–µ–Ω—ã `updateAccountBalance()` –∏ `updateAccountBalances()`
- `AIFinanceManager/Services/DataRepositoryProtocol.swift` - —Ä–∞—Å—à–∏—Ä–µ–Ω –ø—Ä–æ—Ç–æ–∫–æ–ª –º–µ—Ç–æ–¥–∞–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
- `AIFinanceManager/Services/UserDefaultsRepository.swift` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- `AIFinanceManager/Services/CSV/CSVImportCoordinator.swift` - –¥–æ–±–∞–≤–ª–µ–Ω `recalculateAll()` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞

–î–∞—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: 2026-02-10

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ë–∞–ª–∞–Ω—Å—ã –ø—Ä–∏ CSV –∏–º–ø–æ—Ä—Ç–µ

### –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ CSV –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –±–∞–ª–∞–Ω—Å–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è 0, —Ç–æ–ª—å–∫–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Ç–æ–º—É, —á—Ç–æ `CSVImportCoordinator` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—á–µ—Ç–∞ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã, –Ω–æ **–Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π**.

### –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω –≤—ã–∑–æ–≤ `recalculateAll()` –≤ –∫–æ–Ω—Ü–µ `CSVImportCoordinator.importTransactions()`:

```swift
// Register accounts in BalanceCoordinator
if let accountsVM = accountsViewModel,
   let balanceCoordinator = transactionsViewModel.balanceCoordinator {
    await balanceCoordinator.registerAccounts(accountsVM.accounts)

    for account in accountsVM.accounts {
        let initialBalance = accountsVM.getInitialBalance(for: account.id) ?? 0
        await balanceCoordinator.setInitialBalance(initialBalance, for: account.id)

        if !account.shouldCalculateFromTransactions {
            await balanceCoordinator.markAsManual(account.id)
        }
    }

    // ‚úÖ CRITICAL: Recalculate balances after CSV import
    // This ensures all accounts reflect the imported transactions
    await balanceCoordinator.recalculateAll(
        accounts: accountsVM.accounts,
        transactions: transactionsViewModel.allTransactions
    )
}
```

### –õ–æ–≥–∏–∫–∞

1. CSV –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ TransactionStore
2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—á–µ—Ç–∞ –≤ BalanceCoordinator
3. **–ù–û–í–û–ï:** –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–≤–∫–ª—é—á–∞—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –≤ Core Data —á–µ—Ä–µ–∑ `persistBalances()`
5. –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –±–∞–ª–∞–Ω—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Core Data

### –û—Ç–ª–∏—á–∏–µ –æ—Ç –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** –ë–∞–ª–∞–Ω—Å—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ Core Data (–ù–ï–¢ –ø–µ—Ä–µ—Å—á–µ—Ç–∞)
- **–ü–æ—Å–ª–µ CSV –∏–º–ø–æ—Ä—Ç–∞:** –ë–∞–ª–∞–Ω—Å—ã **–ü–ï–†–ï–°–ß–ò–¢–´–í–ê–Æ–¢–°–Ø** –Ω–∞ –æ—Å–Ω–æ–≤–µ –í–°–ï–• —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (—Å—Ç–∞—Ä—ã—Ö + –Ω–æ–≤—ã—Ö), –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Core Data

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫:
- –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å ‚Üí –Ω—É–∂–µ–Ω –ø–µ—Ä–µ—Å—á–µ—Ç
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è ‚Üí —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ –±—É–¥–µ—Ç –±—ã—Å—Ç—Ä—ã–º
